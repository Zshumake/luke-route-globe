<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç Luke's Athletic Route Globe</title>
    
    <!-- Cesium.js -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #fc4c02 0%, #ff6b35 50%, #f7931e 100%);
            min-height: 100vh;
            color: #1f2937;
            overflow-x: hidden;
        }

        .header {
            text-align: center;
            padding: 30px 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            color: #fc4c02;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .header p {
            font-size: 1.2em;
            color: #6b7280;
        }

        .main-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            gap: 30px;
        }

        .left-panel {
            flex: 1;
            max-width: 350px;
        }

        .right-panel {
            flex: 2;
            min-height: 600px;
        }

        .controls-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .controls-card h3 {
            color: #fc4c02;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .demo-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #fc4c02 0%, #ff6b35 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .demo-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(252, 76, 2, 0.3);
        }

        .globe-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            height: 600px;
            position: relative;
        }

        #cesiumContainer {
            width: 100%;
            height: 100%;
            border-radius: 15px;
            overflow: hidden;
        }

        .route-info {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
        }

        .route-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .route-item {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .route-item:hover {
            background-color: #f3f4f6;
        }

        .route-name {
            font-weight: 600;
            color: #374151;
        }

        .route-details {
            font-size: 0.9em;
            color: #6b7280;
            margin-top: 5px;
        }

        .run-route { border-left: 4px solid #ff5722; }
        .ride-route { border-left: 4px solid #2196f3; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            text-align: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #fc4c02;
        }

        .stat-label {
            font-size: 0.9em;
            color: #6b7280;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üåç Luke's Athletic Route Globe</h1>
        <p>Explore your running and cycling adventures around the world</p>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="controls-card">
                <h3>üöÄ Get Started</h3>
                <button class="demo-button" id="demoBtn">
                    Load Demo Routes
                </button>
                <p style="font-size: 0.9em; color: #6b7280; margin-top: 10px;">
                    Click to see sample routes from Birmingham, NYC, London, and Sydney
                </p>
            </div>

            <div class="controls-card route-info">
                <h3>üìç Your Routes</h3>
                <div class="route-list" id="routeList">
                    <p style="color: #9ca3af; text-align: center; padding: 20px;">
                        Load demo routes to explore
                    </p>
                </div>
                
                <div class="stats-grid" id="statsGrid" style="display: none;">
                    <div class="stat-card">
                        <span class="stat-value" id="totalRoutes">0</span>
                        <div class="stat-label">Routes</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="totalDistance">0</span>
                        <div class="stat-label">Miles</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="totalTime">0</span>
                        <div class="stat-label">Hours</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="countriesVisited">0</span>
                        <div class="stat-label">Countries</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="globe-container">
                <div id="cesiumContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof Cesium !== 'undefined') {
                console.log('‚úÖ Cesium loaded successfully');
                
                // Disable Ion completely to prevent 401 errors
                try {
                    if (Cesium.Ion) {
                        Cesium.Ion.defaultAccessToken = undefined;
                        // Try to disable Ion entirely
                        Object.defineProperty(Cesium.Ion, 'defaultAccessToken', {
                            get: () => undefined,
                            set: () => {},
                            configurable: false
                        });
                    }
                } catch (e) {
                    console.log('Ion disable attempt:', e.message);
                }
                
                window.routeGlobe = new RouteGlobe();
            } else {
                console.error('‚ùå Cesium failed to load');
                document.getElementById('cesiumContainer').innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #374151; text-align: center; padding: 20px;">
                        <div>
                            <h3>üåç Loading Globe...</h3>
                            <p style="margin: 15px 0;">Please wait while we initialize the 3D globe</p>
                        </div>
                    </div>
                `;
            }
        });

        class RouteGlobe {
            constructor() {
                this.viewer = null;
                this.routes = [];
                this.routeEntities = [];
                this.init();
            }

            init() {
                document.getElementById('demoBtn').addEventListener('click', () => {
                    this.loadDemo();
                });
            }

            async loadDemo() {
                try {
                    console.log('üåç Initializing Route Globe...');
                    
                    // Create realistic routes first
                    this.routes = this.createRealisticRoutes();
                    
                    // Initialize Cesium globe
                    await this.initializeCesiumGlobe();
                    
                    // Add routes to globe
                    this.addRoutesToGlobe();
                    
                    // Update UI
                    this.updateRouteList();
                    this.updateStats();
                    
                    console.log('‚úÖ Route Globe ready!');
                    
                } catch (error) {
                    console.error('Error initializing route globe:', error);
                    this.showError(error);
                }
            }

            createRealisticRoutes() {
                return [
                    {
                        name: "UAB Medical District Loop",
                        type: "Run",
                        distance: 3.2,
                        duration: 28,
                        location: "Birmingham, AL",
                        country: "USA",
                        coordinates: this.generateBirminghamRoute()
                    },
                    {
                        name: "Central Park Loop",
                        type: "Run", 
                        distance: 6.1,
                        duration: 52,
                        location: "New York, NY",
                        country: "USA",
                        coordinates: this.generateNYCRoute()
                    },
                    {
                        name: "Thames Path Ride",
                        type: "Ride",
                        distance: 15.3,
                        duration: 72,
                        location: "London, UK", 
                        country: "UK",
                        coordinates: this.generateLondonRoute()
                    },
                    {
                        name: "Sydney Harbor Bridge Circuit",
                        type: "Ride",
                        distance: 22.8,
                        duration: 108,
                        location: "Sydney, Australia",
                        country: "Australia", 
                        coordinates: this.generateSydneyRoute()
                    }
                ];
            }

            generateBirminghamRoute() {
                const waypoints = [
                    [-86.8066, 33.5022, 180], // UAB Campus
                    [-86.8045, 33.5035, 185],
                    [-86.8025, 33.5048, 190], 
                    [-86.8010, 33.5055, 195],
                    [-86.8000, 33.5045, 190],
                    [-86.8015, 33.5030, 185],
                    [-86.8040, 33.5015, 180],
                    [-86.8055, 33.5008, 175],
                    [-86.8066, 33.5022, 180]
                ];
                return this.interpolateRoute(waypoints, 50);
            }

            generateNYCRoute() {
                const waypoints = [
                    [-73.9712, 40.7831, 45], // Central Park West
                    [-73.9581, 40.7831, 50], // East side
                    [-73.9581, 40.7688, 55], // Southeast
                    [-73.9712, 40.7688, 50], // Southwest  
                    [-73.9712, 40.7831, 45]  // Back to start
                ];
                return this.interpolateRoute(waypoints, 80);
            }

            generateLondonRoute() {
                const waypoints = [
                    [-0.1276, 51.5074, 15], // Westminster
                    [-0.0759, 51.5048, 20], // London Bridge
                    [-0.0249, 51.4951, 25], // Canary Wharf
                    [0.0103, 51.4814, 30],  // Greenwich
                    [0.0249, 51.4706, 35]   // Beyond Greenwich
                ];
                return this.interpolateRoute(waypoints, 120);
            }

            generateSydneyRoute() {
                const waypoints = [
                    [151.2093, -33.8688, 25], // Sydney Opera House
                    [151.2167, -33.8548, 30], // Harbor Bridge
                    [151.2099, -33.8415, 35], // North Sydney
                    [151.1957, -33.8559, 40], // Circular Quay area
                    [151.2093, -33.8688, 25]  // Back to Opera House
                ];
                return this.interpolateRoute(waypoints, 150);
            }

            interpolateRoute(waypoints, numPoints) {
                const coordinates = [];
                for (let i = 0; i < waypoints.length - 1; i++) {
                    const start = waypoints[i];
                    const end = waypoints[i + 1]; 
                    const segmentPoints = Math.floor(numPoints / (waypoints.length - 1));
                    
                    for (let j = 0; j < segmentPoints; j++) {
                        const t = j / segmentPoints;
                        const lng = start[0] + (end[0] - start[0]) * t;
                        const lat = start[1] + (end[1] - start[1]) * t;
                        const alt = start[2] + (end[2] - start[2]) * t;
                        
                        coordinates.push(lng, lat, alt);
                    }
                }
                return coordinates;
            }

            async initializeCesiumGlobe() {
                console.log('üöÄ Initializing Cesium globe...');
                
                try {
                    // Create basic Cesium viewer with minimal options
                    this.viewer = new Cesium.Viewer('cesiumContainer', {
                        // UI controls
                        homeButton: false,
                        sceneModePicker: false,
                        baseLayerPicker: false,
                        navigationHelpButton: false,
                        animation: false,
                        timeline: false,
                        fullscreenButton: false,
                        geocoder: false,
                        
                        // Disable problematic features
                        shouldAnimate: false,
                        requestRenderMode: false, // Disable to avoid worker issues
                        
                        // Use basic terrain to avoid Ion
                        terrainProvider: new Cesium.EllipsoidTerrainProvider()
                    });
                    
                    // Force disable any Ion attempts
                    if (this.viewer.scene && this.viewer.scene.globe) {
                        // Use basic ellipsoid without Ion services
                        console.log('üåç Using basic ellipsoid terrain');
                    }
                    
                    // Set initial camera position (space view)
                    this.viewer.camera.setView({
                        destination: Cesium.Cartesian3.fromDegrees(0, 0, 20000000), // 20,000km altitude
                    });
                    
                    console.log('‚úÖ Cesium globe initialized');
                    
                } catch (error) {
                    console.error('Cesium initialization error:', error);
                    throw error;
                }
            }

            addRoutesToGlobe() {
                console.log('üó∫Ô∏è Adding GPS routes to globe...');
                
                this.routes.forEach(route => {
                    try {
                        // Create polyline for the route
                        const entity = this.viewer.entities.add({
                            name: route.name,
                            polyline: {
                                positions: Cesium.Cartesian3.fromDegreesArrayHeights(route.coordinates),
                                width: route.type === 'Run' ? 4 : 6,
                                material: route.type === 'Run' ? 
                                    Cesium.Color.ORANGERED : 
                                    Cesium.Color.DEEPSKYBLUE,
                                clampToGround: true,
                                outline: true,
                                outlineColor: Cesium.Color.WHITE,
                                outlineWidth: 1
                            },
                            // Add start point marker
                            point: {
                                pixelSize: 12,
                                color: route.type === 'Run' ? Cesium.Color.ORANGERED : Cesium.Color.DEEPSKYBLUE,
                                outlineColor: Cesium.Color.WHITE,
                                outlineWidth: 2,
                                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                            },
                            position: Cesium.Cartesian3.fromDegreesArrayHeights(route.coordinates)[0]
                        });
                        
                        // Store route data
                        entity.routeData = route;
                        this.routeEntities.push(entity);
                        
                        console.log(`‚úÖ Added route: ${route.name}`);
                        
                    } catch (routeError) {
                        console.error(`‚ùå Failed to add route ${route.name}:`, routeError);
                    }
                });
                
                console.log(`‚úÖ Added ${this.routeEntities.length} GPS routes to globe`);
            }

            updateRouteList() {
                const routeList = document.getElementById('routeList');
                
                if (this.routes.length === 0) {
                    routeList.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 20px;">No routes loaded</p>';
                    return;
                }
                
                const routeHTML = this.routes.map((route, index) => `
                    <div class="route-item ${route.type.toLowerCase()}-route" onclick="routeGlobe.flyToRoute(${index})">
                        <div class="route-name">${route.name}</div>
                        <div class="route-details">
                            ${route.type} ‚Ä¢ ${route.distance} mi ‚Ä¢ ${Math.floor(route.duration/60)}h ${route.duration%60}m ‚Ä¢ ${route.location}
                        </div>
                    </div>
                `).join('');
                
                routeList.innerHTML = routeHTML;
            }

            updateStats() {
                const statsGrid = document.getElementById('statsGrid');
                if (this.routes.length > 0) {
                    statsGrid.style.display = 'grid';
                    
                    const totalDistance = this.routes.reduce((sum, route) => sum + route.distance, 0);
                    const totalTime = this.routes.reduce((sum, route) => sum + route.duration, 0);
                    const countries = new Set(this.routes.map(route => route.country));
                    
                    document.getElementById('totalRoutes').textContent = this.routes.length;
                    document.getElementById('totalDistance').textContent = totalDistance.toFixed(1);
                    document.getElementById('totalTime').textContent = Math.round(totalTime / 60);
                    document.getElementById('countriesVisited').textContent = countries.size;
                }
            }

            flyToRoute(index) {
                const route = this.routes[index];
                if (!route) return;
                
                console.log(`üéØ Flying to route: ${route.name}`);
                
                // Get route bounds
                const coords = [];
                for (let i = 0; i < route.coordinates.length; i += 3) {
                    coords.push(route.coordinates[i], route.coordinates[i + 1]);
                }
                
                const positions = Cesium.Cartesian3.fromDegreesArray(coords);
                
                this.viewer.camera.flyToBoundingSphere(
                    Cesium.BoundingSphere.fromPoints(positions),
                    {
                        duration: 2.0,
                        offset: new Cesium.HeadingPitchRange(0, -0.5, 10000)
                    }
                );
            }

            showError(error) {
                document.getElementById('cesiumContainer').innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ef4444; text-align: center; padding: 20px;">
                        <div>
                            <h3>‚ùå Globe Error</h3>
                            <p style="margin: 15px 0;">${error.message}</p>
                            <button onclick="location.reload()" style="margin-top: 15px; padding: 10px 20px; background: #fc4c02; color: white; border: none; border-radius: 8px; cursor: pointer;">Retry</button>
                        </div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>